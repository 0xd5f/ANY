{% extends "base.html" %}
{% block title %}Changelog{% endblock %}

{% block stylesheets %}
<!-- Marked.js Library -->
<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
{% endblock %}

{% block content %}
<div class="p-6 space-y-6" x-data="changelogData()">
    
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Changelog</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">История изменений ANY Panel</p>
        </div>
        <button @click="loadChangelog()" :disabled="loading" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg transition-colors duration-200 flex items-center gap-2">
            <i class="fas fa-sync-alt" :class="{'animate-spin': loading}"></i>
            <span>Обновить</span>
        </button>
    </div>

    <!-- Changelog Content -->
    <div class="bg-white dark:bg-zinc-900 rounded-xl border border-gray-200 dark:border-zinc-800 overflow-hidden">
        
        <!-- Loading State -->
        <div x-show="loading" class="p-12 text-center">
            <div class="inline-flex items-center gap-3 text-gray-500 dark:text-gray-400">
                <i class="fas fa-spinner fa-spin text-2xl"></i>
                <span class="text-lg">Загрузка changelog...</span>
            </div>
        </div>

        <!-- Error State -->
        <div x-show="error && !loading" class="p-12 text-center">
            <div class="inline-flex flex-col items-center gap-3">
                <i class="fas fa-exclamation-triangle text-4xl text-red-500"></i>
                <p class="text-lg font-medium text-gray-900 dark:text-white">Ошибка загрузки</p>
                <p class="text-sm text-gray-500 dark:text-gray-400" x-text="error"></p>
                <button @click="loadChangelog()" class="mt-4 px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition-colors">
                    Попробовать снова
                </button>
            </div>
        </div>

        <!-- Content -->
        <div x-show="!loading && !error" class="p-8">
            <div x-html="changelogContent" class="changelog-content"></div>
        </div>
    </div>

</div>

<script>
function changelogData() {
    return {
        changelogContent: '',
        loading: false,
        error: null,
        
        async loadChangelog() {
            this.loading = true;
            this.error = null;
            
            try {
                if (typeof marked === 'undefined') {
                    throw new Error('Marked library not loaded');
                }
                
                const timestamp = new Date().getTime();
                const url = `https://raw.githubusercontent.com/0xd5f/ANY/main/changelog.md?t=${timestamp}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Accept': 'text/plain, text/markdown, */*'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to load changelog (${response.status})`);
                }
                
                const text = await response.text();
                
                if (!text || text.trim() === '') {
                    throw new Error('Changelog file is empty');
                }
                
                this.changelogContent = marked.parse ? marked.parse(text) : marked(text);
            } catch (err) {
                this.error = err.message || 'Failed to fetch';
                console.error('Error loading changelog:', err);
            } finally {
                this.loading = false;
            }
        },
        
        init() {
            this.loadChangelog();
        }
    }
}
</script>

<style>
.changelog-content {
    font-size: 1rem;
    line-height: 1.75;
}

.changelog-content h1 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    color: #111827;
}

.dark .changelog-content h1 {
    color: #f9fafb;
}

.changelog-content h2 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e5e7eb;
    color: #111827;
}

.dark .changelog-content h2 {
    border-bottom-color: #3f3f46;
    color: #f9fafb;
}

.changelog-content h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    color: #059669;
}

.dark .changelog-content h3 {
    color: #10b981;
}

.changelog-content ul {
    list-style-type: disc;
    padding-left: 2rem;
    margin: 1rem 0;
}

.changelog-content li {
    margin-bottom: 0.5rem;
    line-height: 1.75;
    color: #374151;
}

.dark .changelog-content li {
    color: #d1d5db;
}

.changelog-content p {
    margin: 1rem 0;
    line-height: 1.75;
    color: #374151;
}

.dark .changelog-content p {
    color: #d1d5db;
}

.changelog-content strong {
    font-weight: 600;
    color: #111827;
}

.dark .changelog-content strong {
    color: #f9fafb;
}

.changelog-content code {
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    background-color: #f3f4f6;
    color: #dc2626;
}

.dark .changelog-content code {
    background-color: #27272a;
    color: #60a5fa;
}

.changelog-content pre {
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 1rem 0;
    background-color: #f3f4f6;
}

.dark .changelog-content pre {
    background-color: #27272a;
}

.changelog-content pre code {
    background: transparent;
    padding: 0;
    color: #111827;
}

.dark .changelog-content pre code {
    color: #f9fafb;
}

.changelog-content a {
    color: #3b82f6;
    text-decoration: none;
}

.changelog-content a:hover {
    text-decoration: underline;
}

.dark .changelog-content a {
    color: #60a5fa;
}

.changelog-content blockquote {
    border-left: 4px solid #d1d5db;
    padding-left: 1rem;
    margin: 1rem 0;
    color: #6b7280;
}

.dark .changelog-content blockquote {
    border-left-color: #52525b;
    color: #9ca3af;
}
</style>
{% endblock %}
